<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marriage Connection Assessment — Couples (Ranked)</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Open+Sans:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#FFF9F2; color:#1A3C5E; max-width: 980px; margin:auto; padding:20px; box-sizing:border-box; }
  h1,h2,h3,h4{ text-align:center; line-height:1.25; }
  .card { background:#fff; border:2px solid #4D9DE0; border-radius:12px; padding:24px; box-shadow:0 8px 25px rgba(0,0,0,.08); margin: 20px auto; }
  .btn, .answer-btn { background:#4D9DE0; color:#fff; font-weight:700; border:none; border-radius:8px; padding:12px 16px; cursor:pointer; margin:10px auto; display:block; width:100%; max-width:520px; }
  .btn:hover, .answer-btn:hover { background:#3A7FBF; }
  #backBtn { max-width:160px; padding:8px 12px; }
  .hidden{ display:none; }
  .progress-bar-container{ width:100%; max-width:520px; height:10px; background:#E0E0E0; border-radius:5px; margin:8px auto 4px; }
  .progress-bar{ height:100%; background:#FF4D4D; border-radius:5px; transition:width .25s; }
  .muted{ color:#9aa3ab; text-align:center; margin-top:12px; }

  /* Ranking UI */
  .rank-wrap { max-width: 760px; margin: 10px auto; }
  .rank-help { text-align:center; margin:8px 0 14px; }
  .rank-list { list-style:none; padding:0; margin:0; }
  .rank-item {
    display:flex; align-items:center; gap:10px;
    background:#fff; border:1px solid #4D9DE0; border-radius:8px;
    padding:10px 12px; margin:8px 0; cursor:grab;
  }
  .rank-item.dragging{ opacity:.6; }
  .rank-badge{ min-width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; background:#4D9DE0; color:#fff; font-weight:700; }
  .rank-title{ font-weight:700; }
  .rank-actions { margin-left:auto; display:flex; gap:6px; }
  .rank-actions button { padding:6px 10px; font-size:.9rem; border-radius:6px; border:1px solid #4D9DE0; background:#fff; color:#1A3C5E; cursor:pointer; }
  .rank-actions button:hover{ background:#f0f6ff; }

  /* Q buttons & pills */
  .question-box { background:#fff; border:1px solid #4D9DE0; border-radius:8px; padding:16px; margin:14px auto; max-width:760px; }
  .vertical-list .answer-btn{ margin:8px auto; max-width:760px; }
  .pill { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid #d0d7de; margin:6px; cursor:pointer; }
  .pill.selected{ background:#3A7FBF; border-color:#3A7FBF; color:#fff; }

  /* Results */
  .result-block { margin-bottom:16px; page-break-inside:avoid; padding:16px; border-left:8px solid #4D9DE0; border-radius:8px; background:#fff; }
  .section-title { color:#1A3C5E; font-family:'Open Sans',sans-serif; font-weight:700; font-size:16pt; margin-bottom:10px; }
  .subsection-title { color:#1A3C5E; font-family:'Roboto',sans-serif; font-weight:600; font-size:14pt; margin: 15px 0 8px; text-align:center; }
  .section-divider{ height:1pt; background-color:#FF4D4D; width:100%; max-width:860px; margin:24pt auto; }
  .subsection-divider{ height:1pt; background-color:rgba(77,157,224,.5); width:100%; max-width:860px; margin:14pt auto; }
  .verse{ font-style:italic; color:#334E7D; text-align:center; margin:4px auto 10px; max-width:820px; }
  .intro-text{ margin:8px auto 12px; line-height:1.45; }
  .couple-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:start; position:relative; padding:10px 0; }
  .couple-grid::before{ content:""; position:absolute; left:50%; top:0; width:2px; height:100%; background:#4D9DE0; transform:translateX(-1px); }
  .partner-card{ border:none; }
  .partner-inner{ border-radius:12px; padding:8px; }
  .partner-header{ font-weight:700; text-align:center; margin-bottom:6px; }

  .results-list{ list-style-position:outside; margin-left:20px; text-align:left; }
  .results-list li{ margin-bottom:6px; }

  .framed-highlight{ border:2px solid #4D9DE0; border-radius:12px; padding:16px; background:rgba(77,157,224,.08); }

  @media (max-width:700px){
    .couple-grid{ grid-template-columns:1fr; }
    .couple-grid::before{ display:none; }
  }

  .html2pdf__page-break { height:0; }
  @media print{
    .btn { display:none !important; }
    .card{ border:none; box-shadow:none; }
    body{ background:#fff; }
    .html2pdf__page-break{ break-before:page; page-break-before:always; }
  }
</style>
</head>
<body>

<!-- Intro -->
<div id="introPage" class="card">
  <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" alt="Logo" style="display:block; margin:0 auto 12px; max-width:200px;" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'">
  <h1>Discover Your Marriage Connection Profile</h1>
  <div class="intro-text">
    <h3 style="text-align:center;margin-top:0;">Rank your intimacy, then explore your rhythms</h3>
    <p>This couples assessment lets each of you rank the 12 intimacy types, capture how you give and receive love, and reflect on everyday relational dynamics. You’ll get a side-by-side guide with clear next steps.</p>
    <p><strong>Couples only:</strong> Partner A goes first, then pass the device to Partner B.</p>
  </div>
  <div class="row" style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
    <input id="partnerAName" class="input" placeholder="Partner A name" aria-label="Partner A name" style="border:1px solid #4D9DE0; border-radius:8px; padding:10px 12px; min-width:220px;">
    <input id="partnerBName" class="input" placeholder="Partner B name" aria-label="Partner B name" style="border:1px solid #4D9DE0; border-radius:8px; padding:10px 12px; min-width:220px;">
  </div>
  <button id="startBtn" class="btn" style="max-width:260px;">Start Couples Assessment</button>
  <p class="muted">HappyMarriageHappyLife.com</p>
</div>

<!-- Quiz -->
<div id="quizPage" class="card hidden">
  <h2 id="quizTitle">Assessment</h2>
  <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="progress" style="text-align:center; margin-bottom:8px;"></div>
  <div id="questionContainer" class="question-box"></div>
  <div style="display:flex; gap:10px; justify-content:center;">
    <button id="backBtn" class="btn" style="display:none; max-width:160px;">Back</button>
  </div>
  <p class="muted">HappyMarriageHappyLife.com</p>
</div>

<!-- Results -->
<div id="resultPage" class="card hidden">
  <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" alt="Logo" style="display:block; margin:0 auto 12px; max-width:200px;" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'">
  <h2 id="resultsHeader">Your Marriage Connection Profile</h2>
  <div id="resultsIntro" class="intro-text">
    <h3 style="text-align:center;margin-top:0;">Your Marriage Connection Profile: The Journey Begins</h3>
    <p>Welcome to your personalized guide to understanding each other in a new way. This profile is built on the Covenant Intimacy Fulfillment Model™ (CIFM). It’s a living map—helping you name what’s true today and aim for what’s possible tomorrow.</p>
    <p>First you’ll see your ranked intimacy types (with definitions). Then we’ll highlight how you give and receive love, followed by relational dynamics, connection patterns, and personalized conflict strategies.</p>
  </div>
  <div id="results"></div>
  <p class="muted">HappyMarriageHappyLife.com</p>
</div>

<script>
/* ================== Data ================== */
const INTIMACY = {
  Spiritual:{label:"Spiritual Intimacy", desc:"Anchors the relationship in God’s design and purpose. It governs how love is defined and lived out."},
  Emotional:{label:"Emotional Intimacy", desc:"Enables vulnerability, empathy, and emotional safety. It opens the door to all other forms of closeness."},
  Commitment:{label:"Commitment Intimacy", desc:"The covenant glue. It provides the security needed to face challenges and grow deeper in all other areas."},
  Intellectual:{label:"Intellectual Intimacy", desc:"Connecting through thoughts, values, and deep conversations."},
  Affable:{label:"Affable Intimacy", desc:"Agreeable, easy going, peaceful, social, and ease in your interactions."},
  Conflict:{label:"Conflict Intimacy", desc:"Staying connected in disagreement."},
  Recreational:{label:"Recreational Intimacy", desc:"Laughter, playfulness, enjoying life and shared experiences together."},
  Partnership:{label:"Partnership Intimacy", desc:"Managing responsibilities and making decisions together."},
  Stability:{label:"Financial Intimacy (Stability)", desc:"Transparent, honest, and value-aligned management of resources like time and money, fostering trust and stability."},
  Creative:{label:"Creative Intimacy", desc:"Dreaming, building, or creating things together."},
  Physical:{label:"Physical Intimacy", desc:"Touch, presence, comfort, and non-sexual affection."},
  Sexual:{label:"Sexual Intimacy", desc:"Passionate, exclusive, and sacred physical union."}
};
const TYPES = Object.keys(INTIMACY);

const typeColors = {
  Spiritual:"#6A4C93", Emotional:"#FF7A70", Commitment:"#FFB347",
  Intellectual:"#4C6B9B", Affable:"#FFB6C1", Recreational:"#4DD2FF",
  Partnership:"#3CB371", Stability:"#FFD700", Creative:"#FF66CC",
  Conflict:"#FFA552", Physical:"#FF8C69", Sexual:"#E63946"
};
const typeOpac = {
  Spiritual:"rgba(106,76,147,.08)", Emotional:"rgba(255,122,112,.08)", Commitment:"rgba(255,179,71,.08)",
  Intellectual:"rgba(76,107,155,.08)", Affable:"rgba(255,182,193,.08)", Recreational:"rgba(77,210,255,.08)",
  Partnership:"rgba(60,179,113,.08)", Stability:"rgba(255,215,0,.08)", Creative:"rgba(255,102,204,.08)",
  Conflict:"rgba(255,165,82,.08)", Physical:"rgba(255,140,105,.08)", Sexual:"rgba(230,57,70,.08)"
};

const scripture = {
  compassionCare: "“Be completely humble and gentle; be patient, bearing with one another in love.” — Ephesians 4:2",
  socialEngagement: "“Therefore encourage one another and build each other up.” — 1 Thessalonians 5:11",
  decisionLeadership: "“If any of you lacks wisdom, you should ask God … and it will be given to you.” — James 1:5",
  respectRecognition: "“Honor one another above yourselves.” — Romans 12:10",
  connectionPattern: "“Make every effort to keep the unity of the Spirit through the bond of peace.” — Ephesians 4:3",
  conflictStrategies: "“Everyone should be quick to listen, slow to speak and slow to become angry.” — James 1:19"
};

const bondingInsights = {
  SteadyConnector:{label:"Steady Connector", desc:"You create a safe space for open communication.",challenges:"You may assume quick talks fix everything.",conflictStyle:"Seeks harmony; may avoid depth."},
  ReassuranceSeeker:{label:"Reassurance Seeker", desc:"You thrive on frequent affirmations.",challenges:"Validation needs may overwhelm others.",conflictStyle:"May over-pursue reassurance."},
  IndependentConnector:{label:"Independent Connector", desc:"Calm, steady presence; values space.",challenges:"Space can feel like distance.",conflictStyle:"May withdraw or shut down."},
  GuardedConnector:{label:"Guarded Connector", desc:"Builds trust gradually; dependable.",challenges:"Caution can slow openness.",conflictStyle:"May assume negative intent."}
};
const conflictStrategies = {
  SteadyConnector:{
    SteadyConnector:"Both value harmony; use weekly check-ins to address issues early.",
    ReassuranceSeeker:"Offer explicit affirmations while keeping discussions grounded.",
    IndependentConnector:"Allow space first, then return to resolve with calm structure.",
    GuardedConnector:"Slow the pace; listen patiently and avoid pressuring."
  },
  ReassuranceSeeker:{
    SteadyConnector:"Ask for specific reassurance without over-pursuing.",
    ReassuranceSeeker:"Schedule mutual affirmations; avoid spirals by timing out.",
    IndependentConnector:"Seek a brief reassurance before honoring space.",
    GuardedConnector:"Use gentle, concrete requests; avoid escalating tones."
  },
  IndependentConnector:{
    SteadyConnector:"Explain your need for reflection; set a return time.",
    ReassuranceSeeker:"Offer a quick assurance before stepping back.",
    IndependentConnector:"Agree on a clear pause-and-return window.",
    GuardedConnector:"Use structured check-ins; keep tone steady."
  },
  GuardedConnector:{
    SteadyConnector:"Share gradually; acknowledge their harmony focus.",
    ReassuranceSeeker:"Offer small affirmations to reduce anxiety.",
    IndependentConnector:"Blend caution with steady pacing and check-ins.",
    GuardedConnector:"Build trust with small daily gestures before hard topics."
  }
};

/* ================== Flow/State ================== */
let partnerAName="", partnerBName="";
let partnerIndex = 0; // 0 = A, 1 = B
// Steps: 0 rank, 1 expressed, 2 desired, 3 social1, 4 social2, 5 decision1, 6 decision2, 7 rr1, 8 rr2, 9 bond1, 10 bond2, 11 bond3, 12 bond4
const TOTAL_STEPS = 13;
let step = 0;

// per-partner answers
let answers = {
  rank: [],               // array of 12 type keys
  expressedTop2: [],      // ["Playful", ...]
  desiredTop2:   [],      // ["Warmth", ...]
  social:   {},           // stepIds -> key
  decision: {},           // stepIds -> key
  rr: { rr1:null, rr2:null }, // 0..3
  bond: {}                // stepIds -> bondingKey
};

const profiles = []; // two partner result objects

/* ================== Boot ================== */
document.getElementById('startBtn').onclick = () => {
  partnerAName = document.getElementById('partnerAName').value.trim();
  partnerBName = document.getElementById('partnerBName').value.trim();
  if(!partnerAName || !partnerBName){ alert("Please enter both Partner A and Partner B names to begin."); return; }
  startPartner(0);
};
document.getElementById('backBtn').onclick = () => { if(step>0){ step--; renderStep(); } };

function startPartner(idx){
  partnerIndex = idx;
  resetAnswers();
  document.getElementById('introPage').classList.add('hidden');
  document.getElementById('quizPage').classList.remove('hidden');
  document.getElementById('quizTitle').textContent = `Assessment — ${idx===0?partnerAName:partnerBName}`;
  step = 0;
  renderStep();
}
function resetAnswers(){
  answers = { rank:[...TYPES], expressedTop2:[], desiredTop2:[], social:{}, decision:{}, rr:{ rr1:null, rr2:null }, bond:{} };
}

/* ================== Render Steps ================== */
function renderStep(){
  const progress = document.getElementById('progress');
  const bar = document.getElementById('progressBar');
  progress.textContent = `Step ${step+1} of ${TOTAL_STEPS}`;
  bar.style.width = `${((step+1)/TOTAL_STEPS)*100}%`;

  const box = document.getElementById('questionContainer');
  box.innerHTML = "";
  // hide Next (we auto-advance), show only Back except step 0 has its own button
  document.getElementById('backBtn').style.display = step>0 ? 'block' : 'none';

  if(step===0) return renderRankUI(box);
  if(step===1) return renderPick2(box, "How you give love — choose your Top 2", "expressedTop2");
  if(step===2) return renderPick2(box, "How you feel most loved — choose your Top 2", "desiredTop2");
  if(step===3) return renderSingleList(box, "In groups, I usually…", [
    ["E","Bring energy and get people talking."],
    ["S","Organize or give structure to the time."],
    ["R","Connect deeply with one or two people."],
    ["A","Keep it light, calm, and agreeable."],
    ["U","Make sure everyone feels included."]
  ], key => { answers.social["social1"]=key; next(); });
  if(step===4) return renderSingleList(box, "Planning social time, I prefer we…", [
    ["E","Pick lively, people-filled activities."],
    ["S","Set a plan and keep on track."],
    ["R","Prioritize meaningful, low-key connection."],
    ["A","Keep it relaxed and pressure-free."],
    ["U","Consider others and include them thoughtfully."]
  ], key => { answers.social["social2"]=key; next(); });
  if(step===5) return renderSingleList(box, "When a decision is needed, I tend to…", [
    ["E","Choose the fun option and keep momentum."],
    ["S","Decide quickly and set direction."],
    ["R","Analyze details before choosing."],
    ["A","Seek harmony and avoid friction."],
    ["U","Support the plan and contribute steadily."]
  ], key => { answers.decision["decision1"]=key; next(); });
  if(step===6) return renderSingleList(box, "On shared projects at home, I usually…", [
    ["E","Keep things upbeat and moving."],
    ["S","Take the lead and drive results."],
    ["R","Plan details and set a thoughtful pace."],
    ["A","Stay flexible and avoid conflict."],
    ["U","Pitch in steadily and support the plan."]
  ], key => { answers.decision["decision2"]=key; next(); });
  if(step===7) return renderSingleList(box, "I feel my opinions are respected in our relationship.", [
    [3,"Strongly Agree"], [2,"Agree"], [1,"Disagree"], [0,"Strongly Disagree"]
  ], val => { answers.rr.rr1 = Number(val); next(); });
  if(step===8) return renderSingleList(box, "We are aligned on core values and honor our covenant.", [
    [3,"Strongly Agree"], [2,"Agree"], [1,"Disagree"], [0,"Strongly Disagree"]
  ], val => { answers.rr.rr2 = Number(val); next(); });
  if(step===9) return renderSingleList(box, "During conflict, I naturally…", [
    ["SteadyConnector","Use humor to lower tension."],
    ["ReassuranceSeeker","Push for quick resolution."],
    ["IndependentConnector","Withdraw to think it through."],
    ["IndependentConnector","Stay calm to avoid escalation."],
    ["GuardedConnector","Concede just to end it."]
  ], key => { answers.bond["bond1"]=key; next(); });
  if(step===10) return renderSingleList(box, "When I feel unappreciated, I tend to…", [
    ["SteadyConnector","Laugh it off and move on."],
    ["ReassuranceSeeker","Remind my spouse of my effort."],
    ["IndependentConnector","Feel overlooked and pull back."],
    ["IndependentConnector","Let it go to keep peace."],
    ["GuardedConnector","Feel hurt and shut down."]
  ], key => { answers.bond["bond2"]=key; next(); });
  if(step===11) return renderSingleList(box, "After a disagreement, I prefer to…", [
    ["ReassuranceSeeker","Repair quickly together."],
    ["IndependentConnector","Pause, then reconnect with a plan."]
  ], key => { answers.bond["bond3"]=key; next(); });
  if(step===12) return renderSingleList(box, "When overwhelmed, I prefer to…", [
    ["ReassuranceSeeker","Seek closeness and reassurance now."],
    ["IndependentConnector","Have space first, then return to talk."]
  ], key => { answers.bond["bond4"]=key; finalizePartner(); });
}

/* ---------- Step 0: Ranking ---------- */
function renderRankUI(root){
  const wrap = document.createElement('div');
  wrap.className = 'rank-wrap';
  wrap.innerHTML = `
    <h3 style="text-align:center;">Rank the 12 Intimacy Types</h3>
    <p class="rank-help">Drag to reorder (or use ↑ / ↓). Place your most important at the top.</p>
    <ul id="rankList" class="rank-list"></ul>
    <button id="rankContinue" class="btn" style="max-width:260px;">Save Ranking & Continue</button>
  `;
  root.appendChild(wrap);

  const ul = wrap.querySelector('#rankList');
  refreshRankList(ul);

  let dragEl = null;
  ul.addEventListener('dragstart', e=>{
    if(e.target.classList.contains('rank-item')){
      dragEl = e.target; e.dataTransfer.effectAllowed='move'; e.target.classList.add('dragging');
    }
  });
  ul.addEventListener('dragend', e=>{ if(dragEl){ dragEl.classList.remove('dragging'); dragEl=null; }});
  ul.addEventListener('dragover', e=>{
    e.preventDefault();
    const after = getDragAfterElement(ul, e.clientY);
    const dragging = ul.querySelector('.dragging');
    if(!dragging) return;
    if(after==null) ul.appendChild(dragging); else ul.insertBefore(dragging, after);
  });
  ul.addEventListener('drop', ()=>{ answers.rank = [...ul.querySelectorAll('.rank-item')].map(li=>li.dataset.key); refreshRankList(ul); });

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.rank-item:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset<0 && offset>closest.offset) return {offset, element:child};
      else return closest;
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }

  document.getElementById('rankContinue').onclick = ()=>{
    answers.rank = [...ul.querySelectorAll('.rank-item')].map(li=>li.dataset.key);
    if(answers.rank.length!==12){ alert("Please rank all 12 types."); return; }
    next();
  };
}
function refreshRankList(ul){
  ul.innerHTML = "";
  answers.rank.forEach((k, idx)=>{
    const li = document.createElement('li');
    li.className = 'rank-item';
    li.draggable = true;
    li.dataset.key = k;
    li.innerHTML = `
      <span class="rank-badge">${idx+1}</span>
      <div>
        <div class="rank-title">${INTIMACY[k].label}</div>
        <div style="font-size:.9rem;color:#4a607a;">${INTIMACY[k].desc}</div>
      </div>
      <div class="rank-actions">
        <button type="button" aria-label="Move up">↑</button>
        <button type="button" aria-label="Move down">↓</button>
      </div>
    `;
    const [upBtn, downBtn] = li.querySelectorAll('.rank-actions button');
    upBtn.onclick = () => {
      const i = answers.rank.indexOf(k);
      if(i>0){ [answers.rank[i-1], answers.rank[i]] = [answers.rank[i], answers.rank[i-1]]; refreshRankList(ul); }
    };
    downBtn.onclick = () => {
      const i = answers.rank.indexOf(k);
      if(i<answers.rank.length-1){ [answers.rank[i+1], answers.rank[i]] = [answers.rank[i], answers.rank[i+1]]; refreshRankList(ul); }
    };
    ul.appendChild(li);
  });
}

/* ---------- Pick-2 (steps 1–2) ---------- */
const affectionOptions = [
  {key:"Playful", text:"Playful moments and upbeat encouragement"},
  {key:"Initiative", text:"Taking initiative—removing stressors"},
  {key:"DeepTalk", text:"Deep conversation and focused time"},
  {key:"Warmth", text:"Warm presence and gentle touch"},
  {key:"Support", text:"Practical help and steady teamwork"}
];
function renderPick2(root, title, field){
  const selected = answers[field];
  const div = document.createElement('div');
  div.innerHTML = `<h3 style="text-align:center;">${title}</h3>
    <p class="rank-help">Tap to select two. Your first tap is #1, second is #2. Tap again to unselect.</p>
    <div id="pick2Wrap" style="text-align:center;"></div>
    <p style="text-align:center; margin-top:8px;">Selected: <strong>${selected.map((k,i)=>`${i+1}. ${labelFor(k)}`).join("  ")||"—"}</strong></p>`;
  root.appendChild(div);
  const wrap = div.querySelector('#pick2Wrap');
  affectionOptions.forEach(o=>{
    const pill = document.createElement('span');
    pill.className = 'pill' + (selected.includes(o.key) ? ' selected' : '');
    pill.textContent = o.text;
    pill.onclick = ()=>{
      if(selected.includes(o.key)){
        answers[field] = selected.filter(x=>x!==o.key);
        renderStep();
      }else{
        if(selected.length<2){
          answers[field] = [...selected, o.key];
          if(answers[field].length===2) return next();
          renderStep();
        }
      }
    };
    wrap.appendChild(pill);
  });
}
function labelFor(k){
  return {Playful:"Playful moments", Initiative:"Taking initiative", DeepTalk:"Deep conversation", Warmth:"Warm presence & touch", Support:"Practical support"}[k]||k;
}

/* ---------- Single-choice helpers ---------- */
function renderSingleList(root, title, options, onPick){
  root.innerHTML = `<h3 style="text-align:center;">${title}</h3><div class="vertical-list"></div>`;
  const v = root.querySelector('.vertical-list');
  options.forEach(([val, txt])=>{
    const b = document.createElement('button');
    b.className = 'answer-btn';
    b.textContent = txt;
    b.onclick = ()=> onPick(val);
    v.appendChild(b);
  });
}

/* Navigation */
function next(){ step++; if(step<TOTAL_STEPS) renderStep(); else finalizePartner(); }

/* ================== Build profile & results ================== */
function finalizePartner(){
  const name = partnerIndex===0 ? partnerAName : partnerBName;

  // Social/Decision summaries (combine 2 items each)
  const socialCounts = {E:0,S:0,R:0,A:0,U:0};
  Object.values(answers.social).forEach(k=> socialCounts[k]++);
  const decisionCounts = {E:0,S:0,R:0,A:0,U:0};
  Object.values(answers.decision).forEach(k=> decisionCounts[k]++);

  const socialSummary = toSummary(socialCounts, {
    E:"You bring energy and enthusiasm to social settings.",
    S:"You give structure and help lead groups well.",
    R:"You prefer deep, thoughtful conversations.",
    A:"You value calm, low-key connection.",
    U:"You make sure others feel included and cared for."
  });
  const decisionSummary = toSummary(decisionCounts, {
    E:"You decide with enthusiasm, prioritizing enjoyment and momentum.",
    S:"You decide decisively, goal-first.",
    R:"You analyze carefully before choosing.",
    A:"You seek harmony and consensus.",
    U:"You steadily support plans and shared goals."
  });

  // Respect & Recognition
  const rrScore = (answers.rr.rr1 ?? 0) + (answers.rr.rr2 ?? 0);
  const rrLabel = rrScore>=5 ? "Strong" : rrScore>=3 ? "Moderate" : "Needs Attention";

  // Bonding style (from 4 items)
  const bondCounts = {SteadyConnector:0, ReassuranceSeeker:0, IndependentConnector:0, GuardedConnector:0};
  Object.values(answers.bond).forEach(k=> bondCounts[k]++);
  const bondingKey = Object.entries(bondCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "SteadyConnector";

  const profile = {
    name,
    ranking: [...answers.rank],
    coreTypes: answers.rank.slice(0,4),
    growthTypes: answers.rank.slice(4,8),
    untappedTypes: answers.rank.slice(8,12),
    expressedTop2: [...answers.expressedTop2],
    desiredTop2: [...answers.desiredTop2],
    socialSummary,
    decisionSummary,
    rrScore, rrLabel,
    bondingKey
  };

  if(partnerIndex===0){
    profiles[0] = profile;
    // Handoff to B
    document.getElementById('quizPage').classList.add('hidden');
    document.getElementById('resultPage').classList.remove('hidden');
    document.getElementById('resultsHeader').textContent = "Partner Handoff";
    document.getElementById('results').innerHTML = `
      <div class="result-block" style="text-align:center;">
        <h3 class="section-title" style="margin-top:0;">Thank you, ${name}!</h3>
        <p class="intro-text">Please pass the device to <strong>${partnerBName}</strong> to complete their part. We’ll show both results side-by-side.</p>
        <button class="btn" style="max-width:240px;" onclick="startPartner(1)">Start Partner B</button>
      </div>
    `;
  } else {
    profiles[1] = profile;
    renderResults();
  }
}

function toSummary(counts, textMap){
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0];
  return top ? textMap[top] : "You adapt flexibly to different situations.";
}

/* ---------- Results Renderer ---------- */
function renderResults(){
  document.getElementById('quizPage').classList.add('hidden');
  document.getElementById('resultPage').classList.remove('hidden');
  document.getElementById('resultsHeader').textContent = "Couples Comparison Profiles";

  const A = profiles[0], B = profiles[1];

  const container = document.createElement('div');
  container.id = "couplesReport";

  /* Section 1: Intimacy */
  container.innerHTML += `
    <div class="section-divider"></div>
    <h3 class="section-title">Section 1: Your Intimacy Preferences</h3>
    <div class="intro-text">
      This section is all about understanding intimacy—not just physical closeness, but the profound experience of being truly known, deeply connected, and fully cherished by your spouse. It begins with your ranked list (with definitions).
      <p>Then we show how you naturally express love and how you feel most loved (Top-2 each), followed by Areas for Growth (next four types) and Untapped Opportunities (lowest four types).</p>
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Your Ranked Lists (with Definitions)</h4>
    <div class="couple-grid">
      ${rankedColumn(A)}${rankedColumn(B)}
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Core Connection Strengths (Top 4 Types)</h4>
    <div class="couple-grid">
      ${typesColumn(A.name, A.coreTypes)}
      ${typesColumn(B.name, B.coreTypes)}
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">How You Give & Receive Love (Top-2 each)</h4>
    <div class="couple-grid">
      ${affectionColumn(A.name, A.expressedTop2, A.desiredTop2)}
      ${affectionColumn(B.name, B.expressedTop2, B.desiredTop2)}
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Areas for Growth (Next 4 Types)</h4>
    <div class="couple-grid">
      ${typesColumn(A.name, A.growthTypes)}
      ${typesColumn(B.name, B.growthTypes)}
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Untapped Opportunities (Lowest 4 Types)</h4>
    <div class="couple-grid">
      ${typesColumn(A.name, A.untappedTypes)}
      ${typesColumn(B.name, B.untappedTypes)}
    </div>
  `;

  /* Section 2: Relational Dynamics (with prompts) */
  container.innerHTML += `
    <div class="section-divider"></div>
    <h3 class="section-title">Section 2: Relational Dynamics</h3>
    <div class="intro-text">
      These everyday rhythms show how you care for each other, engage socially, share influence, and honor one another. Use the prompts to turn insights into action.
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Compassion & Care</h4>
    <div class="verse">${scripture.compassionCare}</div>
    <p class="intro-text">How love is given and received. These are your top ways of expressing care and feeling cared for.</p>
    <div class="couple-grid">
      ${compassionColumn(A)}${compassionColumn(B)}
    </div>
    ${promptsBlock([
      "<em>A \"Love Note\" to Each Other:</em> Using your spouse’s “receive love” picks, write a one-sentence appreciation you’ll do this week.",
      "<em>A Curious Question:</em> “What’s one small thing I could do today that would help you feel especially cared for?”"
    ])}

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Social Preferences</h4>
    <div class="verse">${scripture.socialEngagement}</div>
    <p class="intro-text">How you recharge and engage around people—so you can balance connection and personal space.</p>
    <div class="couple-grid">
      ${simpleBlock(A.name, "Your Social Energy", A.socialSummary)}
      ${simpleBlock(B.name, "Your Social Energy", B.socialSummary)}
    </div>
    ${promptsBlock([
      "<em>The Best of Both Worlds:</em> Share one activity that energizes you with people and one that renews you in quiet.",
      "<em>A \"We & Me\" Plan:</em> Pick one together-activity and one solo recharge this week."
    ])}

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Power & Control</h4>
    <div class="verse">${scripture.decisionLeadership}</div>
    <p class="intro-text">How you navigate decisions and leadership—so collaboration feels respectful and safe.</p>
    <div class="couple-grid">
      ${simpleBlock(A.name, "Your Leadership Style", A.decisionSummary)}
      ${simpleBlock(B.name, "Your Leadership Style", B.decisionSummary)}
    </div>
    ${promptsBlock([
      "<em>A Shared Decision:</em> Choose one decision you have this week. Combine your styles for the best outcome.",
      "<em>A Trust Check-in:</em> Ask, “When do you feel most respected in our decision-making?”"
    ])}

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Respect & Recognition</h4>
    <div class="verse">${scripture.respectRecognition}</div>
    <p class="intro-text">How each partner is valued, affirmed, and honored for who they are.</p>
    <div class="couple-grid">
      ${rrColumn(A)}${rrColumn(B)}
    </div>
    ${promptsBlock([
      "<em>A \"High Five\" Moment:</em> Share a specific time you felt appreciated this week.",
      "<em>The \"One Thing\" Challenge:</em> Each choose one concrete way to honor your spouse this week."
    ])}
  `;

  /* Section 3: Connection Patterns + strategies */
  const aToB = conflictStrategies[A.bondingKey][B.bondingKey];
  const bToA = conflictStrategies[B.bondingKey][A.bondingKey];

  container.innerHTML += `
    <div class="section-divider"></div>
    <h3 class="section-title">Section 3: Connection Patterns</h3>
    <div class="verse">${scripture.connectionPattern}</div>
    <p class="intro-text">Your typical pattern in tension—what helps, what hinders, and how to repair well.</p>
    <div class="couple-grid">
      ${patternColumn(A)}${patternColumn(B)}
    </div>

    <div class="subsection-divider"></div>
    <h4 class="subsection-title">Personalized Conflict Resolution Strategies</h4>
    <div class="verse">${scripture.conflictStrategies}</div>
    <table style="width:100%; border-collapse:collapse; margin:12px 0;">
      <tr><th style="border:1px solid #E0E0E0; padding:8px; background:#4D9DE0; color:#fff;">Partner</th><th style="border:1px solid #E0E0E0; padding:8px; background:#4D9DE0; color:#fff;">Pattern</th><th style="border:1px solid #E0E0E0; padding:8px; background:#4D9DE0; color:#fff;">Strategy</th></tr>
      <tr><td style="border:1px solid #E0E0E0; padding:8px;">${A.name}</td><td style="border:1px solid #E0E0E0; padding:8px;">${bondingInsights[A.bondingKey].label}</td><td style="border:1px solid #E0E0E0; padding:8px;">${aToB}</td></tr>
      <tr><td style="border:1px solid #E0E0E0; padding:8px;">${B.name}</td><td style="border:1px solid #E0E0E0; padding:8px;">${bondingInsights[B.bondingKey].label}</td><td style="border:1px solid #E0E0E0; padding:8px;">${bToA}</td></tr>
    </table>

    <div class="section-divider"></div>
    <div class="framed-highlight">
      <h3 class="section-title" style="margin-top:0;">Thank You</h3>
      <p class="intro-text">Use these insights as a fun tool for introspection and spouse discovery. Choose one insight each week—explore an untapped opportunity, lean into a core strength, or apply a conflict strategy—and try it together.</p>
    </div>

    <div class="section-divider"></div>
    <button id="downloadPdfBtn" class="btn" style="max-width:260px;">Download Couples PDF</button>
  `;

  document.getElementById('results').innerHTML = "";
  document.getElementById('results').appendChild(container);

  // PDF helpers
  async function waitForFontsAndImages(root) {
    const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready.catch(()=>{}) : Promise.resolve();
    const imgs = Array.from(root.querySelectorAll('img'));
    const imagesReady = Promise.all(imgs.map(img=> img.complete ? Promise.resolve() : new Promise(res=>{ img.onload = img.onerror = res; })));
    await Promise.all([fontsReady, imagesReady]);
    await new Promise(r => requestAnimationFrame(()=>requestAnimationFrame(r)));
  }
  function applyPdfPageBreaks(root){
    root.querySelectorAll('.html2pdf__page-break').forEach(n=>n.remove());
    const dividers = Array.from(root.querySelectorAll('.section-divider'));
    for(let i=1;i<dividers.length;i++){
      const marker = document.createElement('div');
      marker.className = 'html2pdf__page-break';
      dividers[i].parentNode.insertBefore(marker, dividers[i]);
    }
  }
  document.getElementById('downloadPdfBtn').onclick = async ()=>{
    const target = document.getElementById('couplesReport');
    const filename = `${A.name}-${B.name}-Connection-Report.pdf`.replace(/\s+/g,'_');
    const prevX = window.scrollX, prevY = window.scrollY;
    document.body.classList.add('no-anim');
    try{
      window.scrollTo(0,0);
      applyPdfPageBreaks(target);
      await waitForFontsAndImages(target);
      const opt = {
        margin:[0.5,0.5,0.5,0.5],
        filename,
        image:{type:'png', quality:1},
        html2canvas:{ scale:2, useCORS:true, logging:false, scrollX:0, scrollY:0, windowWidth:target.scrollWidth, windowHeight:target.scrollHeight },
        jsPDF:{ unit:'in', format:'letter', orientation:'portrait' },
        pagebreak:{ mode:['css','legacy'] }
      };
      await html2pdf().set(opt).from(target).save();
    } finally { document.body.classList.remove('no-anim'); window.scrollTo(prevX, prevY); }
  };
}

/* ---------- results helpers (colored) ---------- */
function rankedColumn(p){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name}</div>
      ${p.ranking.map((k,i)=>`
        <div class="result-block" style="border-left-color:${typeColors[k]}; background:${typeOpac[k]};">
          <strong>${i+1}. ${INTIMACY[k].label}</strong>
          <div style="margin-top:6px;">${INTIMACY[k].desc}</div>
        </div>
      `).join("")}
    </div></div>
  `;
}
function typesColumn(name, types){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name}</div>
      ${types.map(k=>`
        <div class="result-block" style="border-left-color:${typeColors[k]}; background:${typeOpac[k]};">
          <strong>${INTIMACY[k].label}</strong> — ${INTIMACY[k].desc}
        </div>
      `).join("")}
    </div></div>
  `;
}
function affectionColumn(name, expressed2, desired2){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name}</div>
      <div class="result-block" style="border-left-color:#6A4C93; background:rgba(106,76,147,.08);">
        <strong>How You Express Love (Top-2)</strong>
        <ul class="results-list" style="margin-top:6px;">
          ${expressed2.map((k,i)=>`<li>${i+1}. ${affText(k)}</li>`).join("")}
        </ul>
      </div>
      <div class="result-block" style="border-left-color:#E63946; background:rgba(230,57,70,.08);">
        <strong>How You Feel Most Loved (Top-2)</strong>
        <ul class="results-list" style="margin-top:6px;">
          ${desired2.map((k,i)=>`<li>${i+1}. ${affText(k)}</li>`).join("")}
        </ul>
      </div>
    </div></div>
  `;
}
function affText(k){
  return {Playful:"Playful moments and encouragement", Initiative:"Taking initiative / removing stress", DeepTalk:"Deep conversation & focused time", Warmth:"Warm presence & gentle touch", Support:"Practical support & teamwork"}[k]||k;
}
function compassionColumn(p){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name}</div>
      <div class="result-block" style="border-left-color:#6A4C93; background:rgba(106,76,147,.08);">
        <strong>How You Express Love</strong>
        <ul class="results-list" style="margin-top:6px;">
          ${p.expressedTop2.map((k,i)=>`<li>${i+1}. ${affText(k)}</li>`).join("")}
        </ul>
      </div>
      <div class="result-block" style="border-left-color:#E63946; background:rgba(230,57,70,.08);">
        <strong>How You Feel Most Loved</strong>
        <ul class="results-list" style="margin-top:6px;">
          ${p.desiredTop2.map((k,i)=>`<li>${i+1}. ${affText(k)}</li>`).join("")}
        </ul>
      </div>
    </div></div>
  `;
}
function simpleBlock(name, title, text){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name}</div>
      <div class="result-block"><strong>${title}:</strong> ${text}</div>
    </div></div>
  `;
}
function rrColumn(p){
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name}</div>
      <div class="result-block" style="border-left-color:#6A4C93; background:rgba(106,76,147,.08);">
        <strong>Respect & Recognition:</strong> ${p.rrLabel} (${p.rrScore}/6)
        <p style="margin:8px 0 0;">${rrStatement(p.rrScore)}</p>
      </div>
    </div></div>
  `;
}
function patternColumn(p){
  const info = bondingInsights[p.bondingKey];
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name}</div>
      <div class="result-block" style="border-left-color:#4D9DE0; background:rgba(77,157,224,.08);">
        <strong>${info.label}</strong>
        <p><strong>Strengths:</strong> ${info.desc}</p>
        <p><strong>Challenges:</strong> ${info.challenges}</p>
        <p><strong>Typical in Tension:</strong> ${info.conflictStyle}</p>
      </div>
    </div></div>
  `;
}
function rrStatement(score){
  if(score>=5) return "You generally feel affirmed, appreciated, respected, and validated—and you likely offer the same in return.";
  if(score>=3) return "You often feel appreciated and respected, though there may be moments when clearer affirmation would be meaningful.";
  return "You may not consistently feel affirmed or validated; be explicit about the kinds of appreciation that help you feel respected.";
}
function promptsBlock(items){
  return `
    <div class="result-block" style="border-left-color:#FFB347; background:rgba(255,179,71,.08);">
      <strong>Discussion Prompts</strong>
      <ul class="results-list" style="margin-top:6px;">
        ${items.map(li=>`<li>${li}</li>`).join("")}
      </ul>
    </div>
  `;
}
</script>
</body>
</html>
