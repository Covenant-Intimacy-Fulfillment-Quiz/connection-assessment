<!-- Deep-Dive Couples Assessment v2.1 — Intimacy Ranking First -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marriage Connection — Deep-Dive (Ranking First)</title>

  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Open+Sans:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --ink:#1A3C5E; --blue:#4D9DE0; --blue-05:rgba(77,157,224,.08); --rose:#FF4D4D;
      --bg:#FFF9F2; --muted:#A3A3A3; --shadow:0 8px 25px rgba(0,0,0,.08);
    }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--ink); max-width: 900px; margin: auto; padding: 20px; box-sizing: border-box; }
    h1,h2,h3,h4{ text-align:center; line-height:1.25; }
    .card { background:#fff; border:2px solid var(--blue); border-radius:12px; padding:25px; box-shadow:var(--shadow); margin:20px auto; max-width:750px; text-align:center; }
    .btn { background:var(--blue); color:#fff; font-weight:bold; border:none; border-radius:8px; padding:14px 22px; cursor:pointer; margin:12px auto; display:block; width:100%; max-width:500px; }
    .btn:hover{ background:#3A7FBF; }
    .hidden { display:none; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .input{ border:1px solid var(--blue); border-radius:8px; padding:10px 12px; min-width:220px; }
    .logo { display:block; margin:0 auto 15px auto; max-width:200px; }
    .muted{ color:var(--muted); font-size:.9rem; margin-top:10px; }

    /* Progress */
    .progress-bar-container{ width:100%; max-width:500px; height:10px; background:#E0E0E0; border-radius:5px; margin:10px auto; }
    .progress-bar{ height:100%; background:var(--rose); border-radius:5px; transition:width .3s ease; }

    /* Ranking */
    .rank-wrap { max-width:720px; margin:0 auto; text-align:left; }
    .rank-hint { color:var(--muted); font-size:.95rem; margin:8px 0 14px; }
    .rank-list { list-style:none; padding:0; margin:0; }
    .rank-item { background:#fff; border:1px solid var(--blue); border-radius:10px; padding:12px 12px; margin:8px 0; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow); }
    .drag { cursor:grab; user-select:none; font-size:1.25rem; padding:0 6px; }
    .rank-index { width:30px; text-align:center; font-weight:700; color:#2c4a6a; }
    .rank-title { font-weight:700; }
    .rank-desc { color:#35597e; font-size:.9rem; margin-top:2px; }
    .dragging { opacity:.65; }
    .drop-target { outline:2px dashed var(--blue); }

    /* Results blocks */
    .result-block { margin-bottom:16px; page-break-inside:avoid; padding:20px; border-left:8px solid; border-radius:8px; background:#fff; opacity:0; transform:translateY(10px); animation:fadeIn .5s ease forwards; }
    @keyframes fadeIn { to { opacity:1; transform:translateY(0); } }
    .no-anim .result-block { opacity:1 !important; transform:none !important; animation:none !important; }
    .section-title { color:var(--ink); font-family:'Open Sans',sans-serif; font-size:16pt; font-weight:700; text-align:center; margin-bottom:10px; }
    .subsection-title { color:var(--ink); font-family:'Roboto',sans-serif; font-size:14pt; font-weight:600; text-align:center; margin:15px 0 6px; }
    .section-divider { height:1pt; background-color:var(--rose); width:100%; max-width:750px; margin:25pt auto; }
    .subsection-divider{ height:1pt; background:rgba(77,157,224,.5); width:100%; max-width:750px; margin:15pt auto; }

    .results-list { list-style-position:outside; margin-left:20px; text-align:left; }
    .results-list li { margin-bottom:8px; }
    .verse { font-style:italic; color:#334E7D; text-align:center; margin:6px auto 10px; max-width:700px; }

    table { width:100%; border-collapse:collapse; margin:20px 0; }
    th,td{ border:1px solid #E0E0E0; padding:10px; text-align:left; vertical-align:top; }
    th{ background:var(--blue); color:#fff; }

    @media print{
      .btn{ display:none !important; }
      .card{ border:none; box-shadow:none; }
      body{ background:white; }
      .result-block{ opacity:1 !important; transform:none !important; animation:none !important; }
    }

    /* Colors per type */
  </style>
</head>
<body>
  <!-- Intro -->
  <div id="introPage" class="card">
    <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'"/>
    <h1>Deep-Dive Marriage Connection Assessment</h1>
    <div class="intro-text">
      <h3 style="text-align:center;margin-top:0;">Start with Your Intimacy Priorities</h3>
      <p>First, you’ll <strong>rank the 12 types of intimacy</strong> from most important to least. Then you’ll answer a few quick items about how you <strong>express love</strong>, how you <strong>feel most loved</strong>, and your <strong>connection pattern</strong> under tension.</p>
      <p><strong>Couples only:</strong> You’ll both complete it on one device, then see a side-by-side comparison with personalized ideas.</p>
    </div>
    <div class="row">
      <input id="partnerAName" class="input" placeholder="Partner A name" aria-label="Partner A name"/>
      <input id="partnerBName" class="input" placeholder="Partner B name" aria-label="Partner B name"/>
    </div>
    <button id="startBtn" class="btn" style="max-width:260px;">Start — Partner A</button>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <!-- Ranking Page (Step 1) -->
  <div id="rankPage" class="card hidden">
    <h2 id="rankTitle">Step 1 of 2 — Rank Your Intimacy Types</h2>
    <div class="rank-wrap">
      <p class="rank-hint">Drag-and-drop to order from <strong>most important (#1)</strong> to <strong>least (#12)</strong>. You can reorder at any time before continuing.</p>
      <ol id="rankList" class="rank-list" aria-label="Rank intimacy types" role="list"></ol>
      <button id="rankContinue" class="btn" style="max-width:260px;">Save Ranking & Continue</button>
    </div>
    <p class="muted">Tip: On mobile, press-and-hold to drag.</p>
  </div>

  <!-- Quiz Page (Step 2) -->
  <div id="quizPage" class="card hidden">
    <h2 id="quizTitle">Step 2 of 2 — Quick Items</h2>
    <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
    <div class="progress" id="progress"></div>
    <div class="question-box" id="questionContainer" role="radiogroup"></div>
    <button class="btn" onclick="goBack()" id="backBtn" style="display:none; max-width:200px;">Previous</button>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <!-- Result Page -->
  <div id="resultPage" class="card hidden">
    <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'"/>
    <h2 id="resultsHeader">Your Personalized Connection Profile</h2>
    <div class="intro-text" id="resultsIntro">
      <h3 style="text-align:center;margin-top:0;">Section 1 — Intimacy Priorities & Core Connection</h3>
      <p>This section shows your ranked intimacy priorities (with definitions), then highlights how you naturally express love and how you feel most loved. Finally, we flag areas to grow and fresh places to explore together.</p>
    </div>
    <div id="results"></div>
    <div id="coupleFlowBtns" class="hidden" style="margin-top:20px;">
      <button id="startPartnerBBtn" class="btn">Start Partner B</button>
    </div>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <script>
    /* ================== Data ================== */
    const intimacyDisplay = {
      Spiritual:"Spiritual Intimacy",
      Emotional:"Emotional Intimacy",
      Commitment:"Commitment Intimacy",
      Intellectual:"Intellectual Intimacy",
      Affable:"Affable Intimacy",
      Conflict:"Conflict Intimacy",
      Recreational:"Recreational Intimacy",
      Partnership:"Partnership Intimacy",
      Stability:"Financial Intimacy (Stability)",
      Creative:"Creative Intimacy",
      Physical:"Physical Intimacy",
      Sexual:"Sexual Intimacy"
    };
    const intimacyDesc = {
      Spiritual:"Anchors the relationship in God’s design and purpose. It governs how love is defined and lived out.",
      Emotional:"Enables vulnerability, empathy, and emotional safety. It opens the door to all other forms of closeness.",
      Commitment:"The covenant glue. It provides the security needed to face challenges and grow deeper in all other areas.",
      Intellectual:"Connecting through thoughts, values, and deep conversations.",
      Affable:"Agreeable, easy going, peaceful, social, and ease in your interactions.",
      Conflict:"Staying connected in disagreement.",
      Recreational:"Laughter, playfulness, enjoying life and shared experiences together.",
      Partnership:"Managing responsibilities and making decisions together.",
      Stability:"Transparent, honest, and value-aligned management of resources like time and money, fostering trust and stability.",
      Creative:"Dreaming, building, or creating things together.",
      Physical:"Touch, presence, comfort, and non-sexual affection.",
      Sexual:"Passionate, exclusive, and sacred physical union."
    };

    const typeColors = {
      Spiritual:"#6A4C93", Emotional:"#FF7A70", Commitment:"#FFB347",
      Intellectual:"#4C6B9B", Affable:"#FFB6C1", Recreational:"#4DD2FF",
      Partnership:"#3CB371", Stability:"#FFD700", Creative:"#FF66CC",
      Conflict:"#FFA552", Physical:"#FF8C69", Sexual:"#E63946"
    };
    const typeOpac = {
      Spiritual:"rgba(106,76,147,.08)", Emotional:"rgba(255,122,112,.08)", Commitment:"rgba(255,179,71,.08)",
      Intellectual:"rgba(76,107,155,.08)", Affable:"rgba(255,182,193,.08)", Recreational:"rgba(77,210,255,.08)",
      Partnership:"rgba(60,179,113,.08)", Stability:"rgba(255,215,0,.08)", Creative:"rgba(255,102,204,.08)",
      Conflict:"rgba(255,165,82,.08)", Physical:"rgba(255,140,105,.08)", Sexual:"rgba(230,57,70,.08)"
    };

    const bondingInsights = {
      SteadyConnector:{desc:"You create a safe space for open communication.",challenges:"You may assume quick talks fix everything.",conflictStyle:"Seeks harmony; may avoid depth."},
      ReassuranceSeeker:{desc:"You thrive on frequent affirmations.",challenges:"Validation needs may overwhelm others.",conflictStyle:"May over-pursue reassurance."},
      IndependentConnector:{desc:"Calm, steady presence; values space.",challenges:"Space can feel like distance.",conflictStyle:"May withdraw or shut down."},
      GuardedConnector:{desc:"Builds trust gradually; dependable.",challenges:"Caution can slow openness.",conflictStyle:"May assume negative intent."}
    };

    const conflictStrategies = {
      SteadyConnector: {
        SteadyConnector: "Both value harmony; use weekly check-ins to address issues early.",
        ReassuranceSeeker: "Offer explicit affirmations while keeping discussions grounded.",
        IndependentConnector: "Allow space first, then return to resolve with calm structure.",
        GuardedConnector: "Slow the pace; listen patiently and avoid pressuring."
      },
      ReassuranceSeeker: {
        SteadyConnector: "Ask for specific reassurance without over-pursuing.",
        ReassuranceSeeker: "Schedule mutual affirmations; avoid spirals by timing out.",
        IndependentConnector: "Seek a brief reassurance, then honor space.",
        GuardedConnector: "Use gentle, concrete requests; avoid escalating tones."
      },
      IndependentConnector: {
        SteadyConnector: "Explain your need for reflection; set a return time.",
        ReassuranceSeeker: "Offer a quick assurance before stepping back.",
        IndependentConnector: "Agree on a clear pause-and-return window.",
        GuardedConnector: "Use structured check-ins; keep tone steady."
      },
      GuardedConnector: {
        SteadyConnector: "Share gradually; acknowledge their harmony focus.",
        ReassuranceSeeker: "Offer small affirmations to reduce anxiety.",
        IndependentConnector: "Blend caution with steady pacing and check-ins.",
        GuardedConnector: "Build trust with small daily gestures before hard topics."
      }
    };

    const scripture = {
      connectionPattern: "“Make every effort to keep the unity of the Spirit through the bond of peace.” — Ephesians 4:3",
      conflictStrategies: "“Everyone should be quick to listen, slow to speak and slow to become angry.” — James 1:19"
    };

    /* ================== State ================== */
    const TYPES = Object.keys(intimacyDisplay);
    const STYLE_KEYS = ["Playful","Initiative","Thoughtful","Warm","Supportive"]; // presentation labels
    const STYLE_MAP = { // internal keys for scoring
      Playful:"Extroverted", Initiative:"StrongWilled", Thoughtful:"Reflective", Warm:"Affable", Supportive:"Supportive"
    };

    let partnerAName = "", partnerBName = "";
    let partnerIndex = 0; // 0 = A, 1 = B

    let rankOrder = []; // array of type keys in order 1..12

    // Affection style scores (no temperament wording in UI)
    let expressed = { Playful:0, Initiative:0, Thoughtful:0, Warm:0, Supportive:0 };
    let desired  = { Playful:0, Initiative:0, Thoughtful:0, Warm:0, Supportive:0 };

    // Connection pattern (derived from 4 quick items; we won't use attachment terms in UI)
    let tensionScores = { closenessNeed:0, spaceNeed:0 }; // map onto patterns

    // Respect & Recognition
    let rrScore = 0;

    const profiles = []; // [{...A},{...B}]

    /* ================== UI Wiring ================== */
    document.getElementById('startBtn').addEventListener('click', () => {
      partnerAName = document.getElementById('partnerAName').value.trim();
      partnerBName = document.getElementById('partnerBName').value.trim();
      if(!partnerAName || !partnerBName){ alert('Please enter both Partner A and Partner B names to begin.'); return; }
      startForPartner(0);
    });

    function startForPartner(idx){
      partnerIndex = idx; resetScores();
      document.getElementById('introPage').classList.add('hidden');
      document.getElementById('rankPage').classList.remove('hidden');
      document.getElementById('rankTitle').textContent = `Step 1 of 2 — Rank Your Intimacy Types — ${idx===0?partnerAName:partnerBName}`;
      buildRankList();
    }

    function resetScores(){
      rankOrder = [...TYPES]; // default list order
      expressed = { Playful:0, Initiative:0, Thoughtful:0, Warm:0, Supportive:0 };
      desired  = { Playful:0, Initiative:0, Thoughtful:0, Warm:0, Supportive:0 };
      tensionScores = { closenessNeed:0, spaceNeed:0 };
      rrScore = 0;
      index = 0; answers = [];
    }

    /* ================== Ranking (Drag & Drop) ================== */
    const rankListEl = document.getElementById('rankList');

    function buildRankList(){
      rankListEl.innerHTML = '';
      rankOrder.forEach((key,i)=>{
        const li = document.createElement('li');
        li.className = 'rank-item';
        li.setAttribute('draggable','true');
        li.dataset.type = key;
        li.innerHTML = `
          <span class="drag" aria-hidden="true">⠿</span>
          <span class="rank-index">${i+1}</span>
          <div>
            <div class="rank-title">${intimacyDisplay[key]}</div>
            <div class="rank-desc">${intimacyDesc[key]}</div>
          </div>
        `;
        addDragHandlers(li);
        rankListEl.appendChild(li);
      });
    }

    function addDragHandlers(el){
      el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
      el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); renumber(); });
    }

    rankListEl.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging = rankListEl.querySelector('.dragging');
      const after = getDragAfterElement(rankListEl, e.clientY);
      if(!after) rankListEl.appendChild(dragging); else rankListEl.insertBefore(dragging, after);
    });

    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.rank-item:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){ return { offset, element: child }; }
        else return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renumber(){
      const items = [...rankListEl.querySelectorAll('.rank-item')];
      items.forEach((li,idx)=> li.querySelector('.rank-index').textContent = idx+1);
    }

    document.getElementById('rankContinue').addEventListener('click', ()=>{
      rankOrder = [...rankListEl.querySelectorAll('.rank-item')].map(li=>li.dataset.type);
      // proceed to quick items
      document.getElementById('rankPage').classList.add('hidden');
      document.getElementById('quizPage').classList.remove('hidden');
      document.getElementById('quizTitle').textContent = `Step 2 of 2 — Quick Items — ${partnerIndex===0?partnerAName:partnerBName}`;
      index = 0; showQuestion();
    });

    /* ================== Quick Items ================== */
    // We avoid temperament jargon. We ask 4 small items for expressed styles, 4 for desired styles,
    // 4 for connection pattern under tension (no "attachment" wording), and 2 for respect/recognition.

    const Q = [
      // Expressed love (choose what fits best)
      { q:"When I show love, it most often looks like…", opts:[
        { text:"Making things playful and fun.", styleE:"Playful" },
        { text:"Taking initiative and removing stressors.", styleE:"Initiative" },
        { text:"Deep conversation and attentive listening.", styleE:"Thoughtful" },
        { text:"Warm presence and physical affection.", styleE:"Warm" },
        { text:"Quiet, practical support and teamwork.", styleE:"Supportive" }
      ]},
      { q:"My default ‘I care’ move is…", opts:[
        { text:"Inject humor or creativity into the moment.", styleE:"Playful" },
        { text:"Solve a problem before it hits you.", styleE:"Initiative" },
        { text:"Ask curious, caring questions.", styleE:"Thoughtful" },
        { text:"Offer a hug and calm presence.", styleE:"Warm" },
        { text:"Do something tangible that helps.", styleE:"Supportive" }
      ]},

      // Desired love (what lands best for me)
      { q:"I feel most loved when my spouse…", opts:[
        { text:"Keeps it light and joyful with me.", styleD:"Playful" },
        { text:"Steps up and takes pressure off.", styleD:"Initiative" },
        { text:"Shares meaningful, focused time and talk.", styleD:"Thoughtful" },
        { text:"Offers warm touch and steady presence.", styleD:"Warm" },
        { text:"Helps quietly and follows through.", styleD:"Supportive" }
      ]},
      { q:"On a rough day, what helps me feel cared for is…", opts:[
        { text:"Laughter and a little spontaneity.", styleD:"Playful" },
        { text:"Someone taking something off my plate.", styleD:"Initiative" },
        { text:"Being heard deeply without fixing.", styleD:"Thoughtful" },
        { text:"Comforting closeness or gentle touch.", styleD:"Warm" },
        { text:"Practical help that eases the load.", styleD:"Supportive" }
      ]},

      // Connection pattern — we avoid labels, but score toward patterns
      { q:"If I don’t hear back quickly, I tend to…", opts:[
        { text:"Assume the best and wait.", cp:{ closenessNeed:0, spaceNeed:1 } },
        { text:"Feel uneasy and want reassurance.", cp:{ closenessNeed:2, spaceNeed:0 } }
      ]},
      { q:"During tension, I’m more likely to…", opts:[
        { text:"Ask for closeness and clarity now.", cp:{ closenessNeed:2, spaceNeed:0 } },
        { text:"Take space to think and return later.", cp:{ closenessNeed:0, spaceNeed:2 } }
      ]},
      { q:"When my spouse is upset, my first move is…", opts:[
        { text:"Move toward them to comfort and connect.", cp:{ closenessNeed:1, spaceNeed:0 } },
        { text:"Give room so we don’t escalate.", cp:{ closenessNeed:0, spaceNeed:1 } }
      ]},
      { q:"After a disagreement, I prefer to…", opts:[
        { text:"Repair quickly together.", cp:{ closenessNeed:2, spaceNeed:0 } },
        { text:"Pause, then reconnect with a plan.", cp:{ closenessNeed:0, spaceNeed:2 } }
      ]},

      // Respect & Recognition
      { q:"I feel my opinions are respected in our relationship.", opts:[
        { text:"Strongly Disagree", rr:0 }, { text:"Disagree", rr:1 }, { text:"Agree", rr:2 }, { text:"Strongly Agree", rr:3 }
      ]},
      { q:"We are aligned on core values and honor our covenant.", opts:[
        { text:"Strongly Disagree", rr:0 }, { text:"Disagree", rr:1 }, { text:"Agree", rr:2 }, { text:"Strongly Agree", rr:3 }
      ]}
    ];

    let index = 0, answers = [];

    function showQuestion(){
      const q = Q[index];
      document.getElementById('progress').textContent = `Item ${index+1} of ${Q.length}`;
      document.getElementById('progressBar').style.width = `${((index+1)/Q.length)*100}%`;
      const box = document.getElementById('questionContainer');
      let html = `<h3>${q.q}</h3>`;
      q.opts.forEach((o,i)=>{
        html += `<button class="btn" style="max-width:680px;" onclick="answer(${i})">${o.text}</button>`;
      });
      box.innerHTML = html;
      document.getElementById('backBtn').style.display = index>0? 'block':'none';
    }

    function answer(i){
      const o = Q[index].opts[i]; if(!o) return; answers[index]=i;
      if(o.styleE) expressed[o.styleE]++;
      if(o.styleD) desired[o.styleD]++;
      if(o.cp){ tensionScores.closenessNeed += o.cp.closenessNeed; tensionScores.spaceNeed += o.cp.spaceNeed; }
      if(o.rr!==undefined) rrScore += o.rr;
      index++; (index<Q.length) ? showQuestion() : showResults();
    }

    function goBack(){
      if(index===0) return; index--;
      const o = Q[index].opts[answers[index]]; if(!o) return;
      if(o.styleE) expressed[o.styleE]--;
      if(o.styleD) desired[o.styleD]--;
      if(o.cp){ tensionScores.closenessNeed -= o.cp.closenessNeed; tensionScores.spaceNeed -= o.cp.spaceNeed; }
      if(o.rr!==undefined) rrScore -= o.rr;
      showQuestion();
    }

    /* ================== Results ================== */
    function topN(obj, n){ return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k); }

    function classifyConnectionPattern(){
      const c = tensionScores.closenessNeed; const s = tensionScores.spaceNeed;
      if(c>=4 && s<3) return 'ReassuranceSeeker';
      if(s>=4 && c<3) return 'IndependentConnector';
      if(c>=3 && s>=3) return 'GuardedConnector';
      return 'SteadyConnector';
    }

    function rrLabel(score){ if(score>=5) return 'Strong'; if(score>=3) return 'Moderate'; return 'Needs Attention'; }
    function rrStatement(score){
      if(score>=5) return 'You generally feel affirmed, appreciated, respected, and validated—and you likely offer the same in return.';
      if(score>=3) return 'You often feel appreciated and respected, though there may be moments when clearer affirmation would be meaningful.';
      return 'You may not consistently feel affirmed or validated; be explicit about the kinds of appreciation that help you feel respected.';
    }

    function buildRankedListHTML(order){
      return order.map((key,idx)=>{
        return `
          <div class="result-block" style="border-left:8px solid ${typeColors[key]}; background:${typeOpac[key]};">
            <strong>#${idx+1} — ${intimacyDisplay[key]}</strong>
            <div style="margin-top:6px;">${intimacyDesc[key]}</div>
          </div>
        `;
      }).join('');
    }

    function styleLabel(k){
      switch(k){
        case 'Playful': return {title:'Playful Connection', desc:'Fun, spontaneity, and lightness that lifts the moment.'};
        case 'Initiative': return {title:'Protective Initiative', desc:'Stepping up, removing stress, and taking action to care.'};
        case 'Thoughtful': return {title:'Thoughtful Presence', desc:'Deep, attentive conversation and being truly understood.'};
        case 'Warm': return {title:'Warm Affection', desc:'Comforting closeness, calm presence, and gentle touch.'};
        default: return {title:'Steady Support', desc:'Quiet service, reliability, and teamwork that eases the load.'};
      }
    }

    function stylesBlocks(keys, accent){
      return keys.map(k=>{
        const lab = styleLabel(k);
        return `
          <div class="result-block" style="border-left:8px solid ${accent}; background:${accent}14;">
            <strong>${lab.title}</strong>
            <div style="margin-top:6px;">${lab.desc}</div>
          </div>
        `;
      }).join('');
    }

    function buildProfile(name){
      const expTop2 = topN(expressed,2);
      const desTop2 = topN(desired,2);
      const pattern = classifyConnectionPattern();
      const rr = rrScore;
      return { name, expTop2, desTop2, pattern, rr, rankOrder:[...rankOrder] };
    }

    function renderResults(){
      const A = profiles[0], B = profiles[1];
      const container = document.createElement('div');
      container.id = 'couplesReport';

      // Section 1: Ranked list + Core + Growth/Untapped
      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 1: Your Intimacy Priorities</h3>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${A.name} — Ranked Intimacy Types</h4>
        ${buildRankedListHTML(A.rankOrder)}
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${B.name} — Ranked Intimacy Types</h4>
        ${buildRankedListHTML(B.rankOrder)}

        <div class="section-divider"></div>
        <h3 class="section-title">Core Connection Strengths</h3>
        <div class="verse">How you naturally show care and how you feel most cared for.</div>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${A.name}</h4>
        ${stylesBlocks(A.expTop2, '#4D9DE0')}
        ${stylesBlocks(A.desTop2, '#6A4C93')}
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${B.name}</h4>
        ${stylesBlocks(B.expTop2, '#4D9DE0')}
        ${stylesBlocks(B.desTop2, '#6A4C93')}

        <div class="section-divider"></div>
        <h3 class="section-title">Areas for Growth & Untapped Opportunities</h3>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${A.name} — Growth Areas (Next Four)</h4>
        ${buildRankedListHTML(A.rankOrder.slice(4,8))}
        <h4 class="subsection-title">${A.name} — Untapped Opportunities (Lowest Four)</h4>
        ${buildRankedListHTML(A.rankOrder.slice(8,12))}
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${B.name} — Growth Areas (Next Four)</h4>
        ${buildRankedListHTML(B.rankOrder.slice(4,8))}
        <h4 class="subsection-title">${B.name} — Untapped Opportunities (Lowest Four)</h4>
        ${buildRankedListHTML(B.rankOrder.slice(8,12))}
      `;

      // Section 2: Connection Patterns & Honor (Respect/Recognition)
      const patternBlock = (p)=>{
        const key = p.pattern; const info = bondingInsights[key];
        const label = key.replace(/([a-z])([A-Z])/g,'$1 $2');
        return `
          <div class="result-block" style="border-left:8px solid #FF7A70; background:rgba(255,122,112,.08);">
            <strong>${label}</strong>
            <p style="margin:.5rem 0 0;"><strong>Strengths:</strong> ${info.desc}</p>
            <p style="margin:.25rem 0 0;"><strong>Challenges:</strong> ${info.challenges}</p>
            <p style="margin:.25rem 0 0;"><strong>When tensions rise:</strong> ${info.conflictStyle}</p>
          </div>`;
      };

      const rrBlock = (p)=>`<div class="result-block" style="border-left:8px solid #6A4C93; background:rgba(106,76,147,.08);"><strong>Respect & Recognition:</strong> ${rrLabel(p.rr)} (${p.rr}/6)<p style="margin:8px 0 0;">${rrStatement(p.rr)}</p></div>`;

      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 2: Connection Patterns & Honor</h3>
        <div class="verse">${scripture.connectionPattern}</div>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${A.name}</h4>
        ${patternBlock(A)}
        ${rrBlock(A)}
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${B.name}</h4>
        ${patternBlock(B)}
        ${rrBlock(B)}
      `;

      // Strategies
      const aToB = conflictStrategies[A.pattern][B.pattern];
      const bToA = conflictStrategies[B.pattern][A.pattern];
      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">Personalized Conflict Strategies</h3>
        <div class="verse">${scripture.conflictStrategies}</div>
        <table>
          <tr><th>Partner</th><th>Pattern</th><th>Strategy</th></tr>
          <tr><td>${A.name}</td><td>${A.pattern.replace(/([a-z])([A-Z])/g,'$1 $2')}</td><td>${aToB}</td></tr>
          <tr><td>${B.name}</td><td>${B.pattern.replace(/([a-z])([A-Z])/g,'$1 $2')}</td><td>${bToA}</td></tr>
        </table>
        <div class="result-block" style="border-left:8px solid var(--blue); background:var(--blue-05);">
          <strong>Bridge the Difference</strong>
          <p>Make a small plan you both agree on for what to do in the first 10 minutes when tension rises (e.g., a brief reassurance or a short pause with a promised return time). Small, consistent steps build trust.</p>
        </div>
        <div class="section-divider"></div>
        <button id="downloadPdfBtn" class="btn" style="max-width:260px;">Download Couples PDF</button>
      `;

      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = ''; resultsEl.appendChild(container);

      // PDF
      async function waitForFontsAndImages(root){
        const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready.catch(()=>{}) : Promise.resolve();
        const imgs = Array.from(root.querySelectorAll('img'));
        const imagesReady = Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res=>{ img.onload=img.onerror=res; }))); 
        await Promise.all([fontsReady, imagesReady]);
        await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      }
      document.getElementById('downloadPdfBtn').onclick = async ()=>{
        const target = document.getElementById('couplesReport');
        const Aname = profiles[0].name.replace(/\s+/g,'_');
        const Bname = profiles[1].name.replace(/\s+/g,'_');
        const filename = `${Aname}-${Bname}-Connection-Report.pdf`;
        const prevX = window.scrollX, prevY = window.scrollY;
        document.body.classList.add('no-anim');
        try{
          window.scrollTo(0,0); await waitForFontsAndImages(target);
          await html2pdf().set({ margin:[0.5,0.5,0.5,0.5], filename, image:{type:'png',quality:1}, html2canvas:{ scale:2, useCORS:true, logging:false, scrollX:0, scrollY:0, windowWidth: target.scrollWidth, windowHeight: target.scrollHeight }, jsPDF:{ unit:'in', format:'letter', orientation:'portrait' }, pagebreak:{ mode:['css','legacy'] } }).from(target).save();
        } finally { document.body.classList.remove('no-anim'); window.scrollTo(prevX, prevY); }
      };

      // Show page
      document.getElementById('quizPage').classList.add('hidden');
      document.getElementById('resultPage').classList.remove('hidden');
      document.getElementById('coupleFlowBtns').classList.add('hidden');
      document.getElementById('resultsHeader').textContent = 'Couples Comparison Profiles';
    }

    function showResults(){
      // Build current partner profile
      const name = (partnerIndex===0? (partnerAName||'Partner A') : (partnerBName||'Partner B'));
      const prof = buildProfile(name);

      if(partnerIndex===0){
        profiles[0] = prof;
        document.getElementById('quizPage').classList.add('hidden');
        document.getElementById('resultPage').classList.remove('hidden');
        document.getElementById('resultsHeader').textContent = 'Partner Handoff';
        document.getElementById('resultsIntro').classList.add('hidden');
        document.getElementById('results').innerHTML = `
          <div class="result-block" style="border-left:8px solid var(--blue); background:var(--blue-05);">
            <h3 class="section-title" style="margin-top:0;">Thank you, ${name}!</h3>
            <p>We’ll reveal the combined results once both partners finish.</p>
            <p><strong>Please pass the device to ${partnerBName||'Partner B'}</strong> to begin.</p>
          </div>`;
        const btns = document.getElementById('coupleFlowBtns');
        btns.classList.remove('hidden');
        document.getElementById('startPartnerBBtn').onclick = ()=>{
          startForPartner(1);
          document.getElementById('resultPage').classList.add('hidden');
        };
      } else {
        profiles[1] = prof;
        renderResults();
      }
    }
  </script>
</body>
</html>
